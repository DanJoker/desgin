# 历史数据转储
## 说明
> 本工程用于解决项目日终时或每天定时任务中自动创建表分区和历史数据转储的问题

## 配置方法
1. 将ms6001添加批量交易控制器表

INSERT INTO `tsp_tran_controller` (`system_code`, `corporate_code`, `tran_group_id`, `step_id`, `tran_code`, `tran_chinese_name`, `execution_code`, `rely_tran_list`, `tran_run_conditions`, `reconnection_num`, `fail_interrupt_code`, `transactions_submit_num`, `data_split_mode`, `data_split_key`, `job_execution_mode`, `max_job_concurrency_num`, `log_level`, `job_split_condition`, `task_run_mode`, `is_skip`, `is_batch_file`, `tran_type`)
VALUES ('100', '025', '你的批量组', '你的步骤号', 'ms6001', '表分区创建和历史数据转储', '1', NULL, NULL, '0', '1', '1', '9', NULL, '4', '50', '3', NULL, '0', '0', '0',  '1');

2. 创建‘app_data_clean’和‘apl_data_clean’表

3. 添加需要备份
```sql
INSERT INTO app_data_clean (tablna, tablds, parmod, histfg,hitana)
VALUES('test', '测试表', 'M', '1','testh');
-- 字段解释
--  tablna: 表名
--  tablds: 表描述
--  partmd: 表分区创建模式：M-按月分区，D-按天分区
--  histfg: 是否备份数据到历史表  0-备份直接删除，2-备份后删除
--  hitana: 历史表表名
```

4. 配置历史表需要授查询权限的用户（MYSQL不需要一般都是库级别权限，username配置为空）
```sql
Insert into knp_glbl (PARMCD,PMKEY1,PMKEY2,PMKEY3,PMVAL1,PMVAL2,PMVAL3,PMVAL4,PMVAL5,module,recver,TMSTMP) 
values ('system.hist','%','%','%','username','3',null,null,'历史表授权用户和授权重试次数','hist','');
```

## 注意点
> 需要进行表分区创建和表分区删除操作的表，需要在创建表示创建表分区

1. Mysql带表分区创建表方式如下

```sql
DROP TABLE IF EXISTS `test`;  
CREATE TABLE `test` (  
  id int(10) unsigned NOT NULL AUTO_INCREMENT,  
  time char(8) NOT NULL COMMENT '业务时间',  
  PRIMARY KEY (id, time)  
) ENGINE=InnoDB AUTO_INCREMENT=12001 DEFAULT CHARSET=utf8  
PARTITION BY RANGE columns(time) 
(PARTITION p201801 VALUES LESS THAN ('20180201'),
 PARTITION p201802 VALUES LESS THAN ('20180301'),
 PARTITION p201803 VALUES LESS THAN ('20180401'),
 PARTITION p201804 VALUES LESS THAN ('20180501'),
 PARTITION p201805 VALUES LESS THAN ('20180601'),
 PARTITION p201806 VALUES LESS THAN ('20180701'));
```