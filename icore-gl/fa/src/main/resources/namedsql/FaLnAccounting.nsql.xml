<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<sqls xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="FaLnAccounting" longname="贷款核算相关SQL" package="cn.sunline.ltts.busi.fa.namedsql" xsi:noNamespaceSchemaLocation="ltts-model.xsd">
    <dynamicSelect cache="none" method="selectAll selectPage selectPageWithCount" type="sql" id="lstFapAccountingProdSceneList" longname="动态查询场景核算事件信息">
        <parameterMap class="java.util.Map">
            <parameter property="org_id" ref="GlDict.A.org_id" jdbcType="VARCHAR" javaType="BaseType.U_CORPNO" mode="in" longname="法人代码" parameterType="condition"/>
            <parameter property="sys_no" ref="GlDict.A.sys_no" jdbcType="VARCHAR" javaType="GlBaseType.U_SYSNO" mode="in" longname="系统编号" parameterType="condition"/>
            <parameter property="scene_code" ref="GlDict.A.scene_code" jdbcType="VARCHAR" javaType="GlBaseType.U_SCENE_CODE" mode="in" longname="场景编号" parameterType="condition"/>
            <parameter property="product_code" ref="GlDict.A.product_code" jdbcType="VARCHAR" javaType="GlBaseType.U_PRODUCT_CODE" mode="in" longname="产品编号" parameterType="condition"/>
            <parameter property="bal_type" ref="GlDict.B.bal_type" jdbcType="VARCHAR" javaType="GlBaseType.U_BAL_TYPE" mode="in" longname="金额类别" parameterType="condition"/>
            <parameter property="loan_term" ref="GlDict.A.loan_term" jdbcType="VARCHAR" javaType="GlBaseType.U_LOAN_TERM" mode="in" longname="贷款期限" parameterType="condition"/>
            <parameter property="gl_code" ref="GlDict.A.gl_code" jdbcType="VARCHAR" javaType="GlBaseType.U_SUBJECTNO" mode="in" longname="科目号" parameterType="condition"/>
            <parameter property="effect_date" ref="GlDict.A.effect_date" jdbcType="VARCHAR" javaType="BaseType.U_DATE08" mode="in" longname="生效日期" parameterType="condition"/>
            <parameter property="invalid_date" ref="GlDict.A.invalid_date" jdbcType="VARCHAR" javaType="BaseType.U_DATE08" mode="in" longname="失效日期" parameterType="condition"/>
        </parameterMap>
        <resultMap class="TabFaParm.fap_accounting_prod_scene"/>
        <dynamicSql type="mysql">
            <str type="Str"><![CDATA[select * from fap_accounting_prod_scene]]></str>
            <where type="Where">
                <and type="And">
                    <if test="org_id != null &amp;&amp; org_id != &quot;&quot;" type="If">
                        <str type="Str"><![CDATA[corpno = #org_id# ]]></str>
                    </if>
                    <if test="sys_no != null &amp;&amp; sys_no!= &quot;&quot;" type="If">
                        <str type="Str"><![CDATA[sys_no = #sys_no#]]></str>
                    </if>
                    <if test="scene_code != null &amp;&amp; scene_code !=&quot;&quot;" type="If">
                        <str type="Str"><![CDATA[scene_code = #scene_code#]]></str>
                    </if>
                    <if test="product_code != null &amp;&amp;product_code!=&quot;&quot;" type="If">
                        <str type="Str"><![CDATA[product_code = #product_code#]]></str>
                    </if>
                    <if test="bal_type != null &amp;&amp;bal_type!=&quot;&quot;" type="If">
                        <str type="Str"><![CDATA[bal_type=#bal_type#]]></str>
                    </if>
                    <if test="loan_term != null &amp;&amp;loan_term!=&quot;&quot;" type="If">
                        <str type="Str"><![CDATA[loan_term=#loan_term#]]></str>
                    </if>
                    <if test="gl_code !=null &amp;&amp; gl_code!=&quot;&quot;" type="If">
                        <str type="Str"><![CDATA[gl_code=#gl_code#]]></str>
                    </if>
                    <if test="effect_date!=null &amp;&amp; effect_date!=&quot;&quot;" type="If">
                        <str type="Str"><![CDATA[effect_date <= #effect_date#]]></str>
                    </if>
                    <if test="invalid_date!=null &amp;&amp; invalid_date!=&quot;&quot;" type="If">
                        <str type="Str"><![CDATA[invalid_date >= #invalid_date#]]></str>
                    </if>
                </and>
            </where>
            <str type="Str"><![CDATA[order by corpno,sys_no,scene_code,data_sort,effect_date desc]]></str>
        </dynamicSql>
    </dynamicSelect>
    <select cache="none" method="selectAll" type="sql" id="lstFapAccountingProdSceneInfos" longname="查询场景核算定义信息">
        <sql><![CDATA[select
    	    	* 
    	from
    	    	fap_accounting_prod_scene 
    	where
    	    	corpno = #org_id#
    	    	and sys_no = #sys_no#
    	    	and scene_code = #scene_code#
    	    	and product_code = #product_code#
    	    	and bal_type = #bal_type#
    	    	and loan_term = #loan_term#
    	    	and effect_date <= #trxn_date#
    	    	and invalid_date >= #trxn_date#
    	order by data_sort asc]]></sql>
        <parameterMap class="java.util.Map">
            <parameter property="org_id" ref="GlDict.A.org_id" jdbcType="VARCHAR" javaType="BaseType.U_CORPNO" mode="in" longname="法人代码" parameterType="condition"/>
            <parameter property="sys_no" ref="GlDict.A.sys_no" jdbcType="VARCHAR" javaType="GlBaseType.U_SYSNO" mode="in" longname="系统编号" parameterType="condition"/>
            <parameter property="scene_code" ref="GlDict.A.scene_code" jdbcType="VARCHAR" javaType="GlBaseType.U_SCENE_CODE" mode="in" longname="场景编号" parameterType="condition"/>
            <parameter property="product_code" ref="GlDict.A.product_code" jdbcType="VARCHAR" javaType="GlBaseType.U_PRODUCT_CODE" mode="in" longname="产品编号" parameterType="condition"/>
            <parameter property="bal_type" ref="GlDict.B.bal_type" jdbcType="VARCHAR" javaType="GlBaseType.U_BAL_TYPE" mode="in" longname="金额类别" parameterType="condition"/>
            <parameter property="loan_term" ref="GlDict.A.loan_term" jdbcType="VARCHAR" javaType="GlBaseType.U_LOAN_TERM" mode="in" longname="贷款期限" parameterType="condition"/>
            <parameter property="trxn_date" ref="GlDict.A.trxn_date" jdbcType="VARCHAR" javaType="GlBaseType.U_DATE" mode="in" longname="交易日期" parameterType="condition"/>
        </parameterMap>
        <resultMap class="TabFaParm.fap_accounting_prod_scene"/>
    </select>
    <select cache="none" method="selectAll" type="sql" id="lstHashValueFromSceneSeq" longname="查询散列值">
        <sql type="mysql"><![CDATA[
        select
                distinct a.hash_value 
        from
                fab_accounting_scene_seq a 
        where
                a.trxn_date=#trxn_date# and a.corpno=#org_id# 
                and a.trxn_seq_status=#trxn_seq_status#   
        ]]></sql>
        <parameterMap class="java.util.Map">
            <parameter property="org_id" ref="GlDict.A.org_id" jdbcType="VARCHAR" javaType="BaseType.U_CORPNO" mode="in" longname="法人代码" parameterType="condition"/>
            <parameter property="trxn_date" ref="GlDict.A.trxn_date" jdbcType="VARCHAR" javaType="GlBaseType.U_DATE" mode="in" longname="交易日期" parameterType="condition"/>
            <parameter property="trxn_seq_status" ref="GlDict.A.trxn_seq_status" jdbcType="VARCHAR" javaType="GlBusinessType.E_TRXNSEQSTATE" mode="in" longname="交易流水状态" parameterType="condition"/>
        </parameterMap>
        <resultMap class="ComFaApFile.ApDataGroupNo"/>
    </select>
    <select cache="none" method="selectAll" type="sql" id="lstAccountingData" longname="按机构、系统、科目、记账方向和币种分组取记账数据">
        <sql type="mysql"><![CDATA[
        select
                count(1) as total_count,a.acct_branch,a.trxn_ccy,a.gl_code, a.debit_credit ,
                a.sys_no ,ifnull(sum(a.trxn_amt),0.00) as total_amt ,a.sub_acct_seq
        from
                fab_original_voch a, fab_accounting_scene_seq b 
        where
        		a.trxn_seq = b.trxn_seq
        		and a.data_sort = b.data_sort
                and b.total_batch_no = #total_batch_no#
                and b.trxn_date = #trxn_date#
        group by
                a.acct_branch,a.trxn_ccy,a.gl_code,
                a.debit_credit ,a.sys_no ,a.sub_acct_seq 
        ]]></sql>
        <parameterMap class="java.util.Map">
            <parameter property="trxn_date" ref="GlDict.A.trxn_date" jdbcType="VARCHAR" javaType="GlBaseType.U_DATE" mode="in" longname="transaction date" parameterType="condition"/>
            <parameter property="total_batch_no" ref="GlDict.A.total_batch_no" jdbcType="VARCHAR" javaType="BaseType.U_SEQUNO" mode="in" longname="汇总批次号" parameterType="condition"/>
        </parameterMap>
        <resultMap class="ComFaAccounting.FaAccountingData"/>
    </select>
    <update method="update" id="updTotalBatchNo" longname="更新记账数据的批次号">
        <sql type="mysql"><![CDATA[update
                fab_accounting_scene_seq a 
        set
                a.total_batch_no=#total_batch_no#
        where
                a.trxn_date=#trxn_date# and a.corpno=#org_id# 
                and a.hash_value = #hash_value#	
                and a.trxn_seq_status=#trxn_seq_status# ]]></sql>
        <parameterMap class="java.util.Map">
            <parameter property="total_batch_no" ref="GlDict.A.total_batch_no" jdbcType="VARCHAR" javaType="BaseType.U_SEQUNO" mode="in" longname="汇总批次号" parameterType="condition"/>
            <parameter property="trxn_date" ref="GlDict.A.trxn_date" jdbcType="VARCHAR" javaType="GlBaseType.U_DATE" mode="in" longname="交易日期" parameterType="condition"/>
            <parameter property="org_id" ref="GlDict.A.org_id" jdbcType="VARCHAR" javaType="BaseType.U_CORPNO" mode="in" longname="法人代码" parameterType="condition"/>
            <parameter property="total_count" ref="GlDict.A.total_count" jdbcType="VARCHAR" javaType="GlBaseType.U_LONG" mode="in" longname="总记录数" parameterType="condition"/>
            <parameter property="trxn_seq_status" ref="GlDict.A.trxn_seq_status" jdbcType="VARCHAR" javaType="GlBusinessType.E_TRXNSEQSTATE" mode="in" longname="交易流水状态" parameterType="condition"/>
            <parameter property="hash_value" ref="GlDict.A.hash_value" jdbcType="VARCHAR" javaType="GlBaseType.U_LONG" mode="in" longname="散列值" parameterType="condition"/>
        </parameterMap>
    </update>
    <update method="update" id="updTrxnSeqStatus" longname="更新记账数据的状态">
        <sql type="mysql"><![CDATA[update
                fab_accounting_scene_seq a 
        set
                a.trxn_seq_status= #trxn_seq_status#
        where
                a.total_batch_no = #total_batch_no#
                and a.trxn_date = #trxn_date# ]]></sql>
        <parameterMap class="java.util.Map">
            <parameter property="trxn_date" ref="GlDict.A.trxn_date" jdbcType="VARCHAR" javaType="GlBaseType.U_DATE" mode="in" longname="交易日期" parameterType="condition"/>
            <parameter property="total_batch_no" ref="GlDict.A.total_batch_no" jdbcType="VARCHAR" javaType="BaseType.U_SEQUNO" mode="in" longname="汇总批次号" parameterType="condition"/>
            <parameter property="trxn_seq_status" ref="GlDict.A.trxn_seq_status" jdbcType="VARCHAR" javaType="GlBusinessType.E_TRXNSEQSTATE" mode="in" longname="交易流水状态" parameterType="condition"/>
        </parameterMap>
    </update>
    <select cache="none" method="selectAll" type="sql" id="lstLnLedgerBalance" longname="贷款外部余额汇总">
        <sql type="mysql"><![CDATA[select
                a.corpno as org_id, a.sys_no,a.trxn_date,a.acct_branch,a.trxn_ccy,
                b.gl_code,'D' as ledger_bal_direction,
                        sum(case when b.bal_debit_credit = 'D' then b.acct_bal
                        else b.acct_bal*(-1) end)
                        as ledger_acct_bal 
        from
                fab_lnledger_check_seq a, fab_lnledger_check_acseq b
        where
        		a.id = b.id
                and a.trxn_date = #trxn_date#
                and a.sys_no = #sys_no#
                and a.corpno = #org_id#
                and a.analysis_state = '2'
        group by
                a.corpno,a.sys_no,a.trxn_date,
                a.acct_branch,a.trxn_ccy,b.gl_code]]></sql>
        <parameterMap class="java.util.Map">
            <parameter property="trxn_date" ref="GlDict.A.trxn_date" jdbcType="VARCHAR" javaType="GlBaseType.U_DATE" mode="in" longname="交易日期" parameterType="condition"/>
            <parameter property="sys_no" ref="GlDict.A.sys_no" jdbcType="VARCHAR" javaType="GlBaseType.U_SYSNO" mode="in" longname="系统编号" parameterType="condition"/>
            <parameter property="org_id" ref="GlDict.A.org_id" jdbcType="VARCHAR" javaType="BaseType.U_CORPNO" mode="in" longname="法人代码" parameterType="condition"/>
        </parameterMap>
        <resultMap class="ComFaAccounting.FaLnLedgerCheckSeqInfo"/>
    </select>
    <update method="update" id="updLnLedgerBalanceStatus" longname="更新分户余额状态更新">
        <sql type="mysql"><![CDATA[
        update fab_lnledger_check_seq a set a.analysis_state = #analysis_state#
where  trxn_date = #trxn_date#
	and corpno = #org_id# and sys_no = #sys_no# and acct_branch = #acct_branch# and trxn_ccy = #trxn_ccy#
and exists (
	select 1 from fab_lnledger_check_acseq b where a.id = b.id and b.gl_code = #gl_code#
)   
        ]]></sql>
        <parameterMap class="java.util.Map">
            <parameter property="analysis_state" ref="GlDict.A.analysis_state" jdbcType="VARCHAR" javaType="GlBusinessType.E_ANALYSISSTATE" mode="in" longname="解析状态" parameterType="condition"/>
            <parameter property="trxn_date" ref="GlDict.A.trxn_date" jdbcType="VARCHAR" javaType="GlBaseType.U_DATE" mode="in" longname="transaction date" parameterType="condition"/>
            <parameter property="org_id" ref="GlDict.A.org_id" jdbcType="VARCHAR" javaType="BaseType.U_CORPNO" mode="in" longname="organization id" parameterType="condition"/>
            <parameter property="sys_no" ref="GlDict.A.sys_no" jdbcType="VARCHAR" javaType="GlBaseType.U_SYSNO" mode="in" longname="系统编号" parameterType="condition"/>
            <parameter property="acct_branch" ref="GlDict.A.acct_branch" jdbcType="VARCHAR" javaType="BaseType.U_BRCHNO" mode="in" longname="账务机构" parameterType="condition"/>
            <parameter property="trxn_ccy" ref="GlDict.A.trxn_ccy" jdbcType="VARCHAR" javaType="BaseType.U_CRCYCD" mode="in" longname="币种" parameterType="condition"/>
            <parameter property="gl_code" ref="GlDict.A.gl_code" jdbcType="VARCHAR" javaType="GlBaseType.U_SUBJECTNO" mode="in" longname="科目号" parameterType="condition"/>
        </parameterMap>
    </update>
    <select cache="none" method="selectOne" type="sql" id="qryLastLnLedgerBalance" longname="查询科目上日余额">
        <sql type="mysql"><![CDATA[select 'D' as ledger_bal_direction,
                        ifnull(sum(case when bal_debit_credit = 'D' then acct_bal
                        else acct_bal*(-1) end) ,0)
                        as ledger_acct_bal 
				from fab_lnledger_check_acseq where gl_code = #gl_code# and  trxn_date = #trxn_date# and corpno = #org_id#
		]]></sql>
        <parameterMap class="java.util.Map">
            <parameter property="trxn_date" ref="GlDict.A.trxn_date" jdbcType="VARCHAR" javaType="GlBaseType.U_DATE" mode="in" longname="交易日期" parameterType="condition"/>
            <parameter property="gl_code" ref="GlDict.A.gl_code" jdbcType="VARCHAR" javaType="GlBaseType.U_SUBJECTNO" mode="in" longname="科目号" parameterType="condition"/>
            <parameter property="org_id" ref="GlDict.A.org_id" jdbcType="VARCHAR" javaType="BaseType.U_CORPNO" mode="in" longname="法人代码" parameterType="condition"/>
        </parameterMap>
        <resultMap class="ComFaAccounting.FaLnLedgerCheckSeqInfo"/>
    </select>
</sqls>
