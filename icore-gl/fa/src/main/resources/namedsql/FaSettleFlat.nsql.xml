<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<sqls xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="FaSettleFlat" longname="批量清算相关sql" package="cn.sunline.ltts.busi.fa.namedsql" xsi:noNamespaceSchemaLocation="ltts-model.xsd">
    <select cache="none" method="selectAll" type="sql" id="lstSettBatchNoList" longname="批量清算数据准备">
        <sql type="oracle"><![CDATA[
    	SELECT
    	    	a.trxn_ccy, b.trxn_branch, nvl(sum(case when a.debit_credit = 'D' then a.accounting_amt else - a.accounting_amt end ), 0) as accounting_amt 
    	FROM
    	    	fab_teller_seq b 
    	JOIN
    	    	fab_accounting_voch a 
    	    	    	ON a.trxn_date = b.trxn_date AND a.trxn_seq = b.trxn_seq 
    	    	    	AND a.corpno = b.corpno 
    	WHERE
    	    	b.corpno = #org_id# AND b.trxn_date = #trxn_date# 
    	    	AND b.sett_batch_no = #sett_batch_no# AND a.on_bal_sheet_ind = 'Y' 
    	    	and b.sett_status='2' 
    	GROUP BY
    	    	a.trxn_ccy, b.trxn_branch 
    	having
    	    	nvl(sum(case when a.debit_credit = 'D' then a.accounting_amt else - a.accounting_amt end ), 0) <> 0 
    	ORDER BY
    	    	a.trxn_ccy,
    	    	b.trxn_branch 
    	]]></sql>
        <sql type="mysql"><![CDATA[
    	SELECT
    	    	a.trxn_ccy, b.trxn_branch, ifnull(sum(case when a.debit_credit = 'D' then a.accounting_amt else - a.accounting_amt end ), 0) as accounting_amt 
    	FROM
    	    	fab_teller_seq b 
    	JOIN
    	    	fab_accounting_voch a 
    	    	    	ON a.trxn_date = b.trxn_date AND a.trxn_seq = b.trxn_seq 
    	    	    	AND a.corpno = b.corpno 
    	WHERE
    	    	b.corpno = #org_id# AND b.trxn_date = #trxn_date# 
    	    	AND b.sett_batch_no = #sett_batch_no# AND a.on_bal_sheet_ind = 'Y' 
    	    	and b.sett_status='2' 
    	GROUP BY
    	    	a.trxn_ccy, b.trxn_branch 
    	having
    	    	ifnull(sum(case when a.debit_credit = 'D' then a.accounting_amt else - a.accounting_amt end ), 0) <> 0 
    	ORDER BY
    	    	a.trxn_ccy,
    	    	b.trxn_branch 
    	]]></sql>
        <sql type="db2"><![CDATA[
    	SELECT
    	    	a.trxn_ccy, b.trxn_branch, value(sum(case when a.debit_credit = 'D' then a.accounting_amt else - a.accounting_amt end ), 0) as accounting_amt 
    	FROM
    	    	fab_teller_seq b 
    	JOIN
    	    	fab_accounting_voch a 
    	    	    	ON a.trxn_date = b.trxn_date AND a.trxn_seq = b.trxn_seq 
    	    	    	AND a.corpno = b.corpno 
    	WHERE
    	    	b.corpno = #org_id# AND b.trxn_date = #trxn_date# 
    	    	AND b.sett_batch_no = #sett_batch_no# AND a.on_bal_sheet_ind = 'Y' 
    	    	and b.sett_status='2' 
    	GROUP BY
    	    	a.trxn_ccy, b.trxn_branch 
    	having
    	    	value(sum(case when a.debit_credit = 'D' then a.accounting_amt else - a.accounting_amt end ), 0) <> 0 
    	ORDER BY
    	    	a.trxn_ccy,
    	    	b.trxn_branch 
    	]]></sql>
        <parameterMap class="java.util.Map">
            <parameter property="org_id" ref="GlDict.A.org_id" jdbcType="VARCHAR" javaType="BaseType.U_CORPNO" mode="in" longname="法人代码" parameterType="condition"/>
            <parameter property="trxn_date" ref="GlDict.A.trxn_date" jdbcType="VARCHAR" javaType="GlBaseType.U_DATE" mode="in" longname="交易日期" parameterType="condition"/>
            <parameter property="sett_batch_no" ref="GlDict.A.sett_batch_no" jdbcType="VARCHAR" javaType="BaseType.U_SEQUNO" mode="in" longname="清算批次号" parameterType="condition"/>
        </parameterMap>
        <resultMap class="ComFaAccounting.SettlePrepData"/>
    </select>
    <update method="update" id="updBatchSettled" longname="批量清算状态变更">
        <sql type="oracle"><![CDATA[
    	UPDATE
    	    	fab_teller_seq a 
    	SET
    	    	a.sett_state = '4' 
    	WHERE
    	    	a.corpno = #org_id# AND a.jiaoyirq = #trxn_date# 
    	    	AND a.sett_batch_no = #sett_batch_no# AND a.sett_status = '3' 
    	]]></sql>
        <sql type="db2"><![CDATA[
    	UPDATE
    	    	fab_teller_seq a 
    	SET
    	    	a.sett_state = '4' 
    	WHERE
    	    	a.corpno = #org_id# AND a.jiaoyirq = #trxn_date# 
    	    	AND a.sett_batch_no = #sett_batch_no# AND a.sett_status = '3' 
    	]]></sql>
        <sql type="mysql"><![CDATA[
    	UPDATE
    	    	fab_teller_seq a 
    	SET
    	    	a.sett_state = '4' 
    	WHERE
    	    	a.corpno = #org_id# AND a.jiaoyirq = #trxn_date# 
    	    	AND a.sett_batch_no = #sett_batch_no# AND a.sett_status = '3' 
    	]]></sql>
        <parameterMap class="java.util.Map">
            <parameter property="trxn_date" ref="GlDict.A.trxn_date" jdbcType="VARCHAR" javaType="GlBaseType.U_DATE" mode="in" longname="交易日期" parameterType="condition"/>
            <parameter property="org_id" ref="GlDict.A.org_id" jdbcType="VARCHAR" javaType="BaseType.U_CORPNO" mode="in" longname="法人代码" parameterType="condition"/>
            <parameter property="sett_batch_no" ref="GlDict.A.sett_batch_no" jdbcType="VARCHAR" javaType="BaseType.U_SEQUNO" mode="in" longname="清算批次号" parameterType="condition"/>
        </parameterMap>
    </update>
    <select cache="none" method="selectAll" type="sql" id="lstSettDataSingle" longname="批量清算数据准备批量逐笔补平">
        <sql type="oracle"><![CDATA[
    	SELECT
    	    	a.trxn_ccy as ccy_code, b.trxn_branch, a.debit_credit, nvl(sum(case when a.debit_credit = 'D' then a.accounting_amt else 0 end ), 0) as debit_amt,
    	    	nvl(sum(case when a.debit_credit = 'C' then a.accounting_amt else 0 end ), 0) as credit_amt 
    	FROM
    	    	fab_teller_seq b 
    	JOIN
    	    	fab_accounting_voch a 
    	    	    	ON a.trxn_date = b.trxn_date AND a.trxn_seq = b.trxn_seq 
    	    	    	AND a.corpno = b.corpno 
    	WHERE
    	    	b.corpno = #org_id# AND b.trxn_date = #trxn_date# 
    	    	AND b.sett_batch_no = #sett_batch_no# AND a.on_bal_sheet_ind = 'Y' 
    	    	and b.sett_status='2' 
    	GROUP BY
    	    	a.trxn_ccy, b.trxn_branch ,a.debit_credit 
    	ORDER BY
    	    	a.trxn_ccy,
    	    	a.debit_credit 
    	]]></sql>
        <sql type="mysql"><![CDATA[
    	SELECT
    	    	a.trxn_ccy as ccy_code, b.trxn_branch, a.debit_credit, ifnull(sum(case when a.debit_credit = 'D' then a.accounting_amt else 0 end ), 0) as debit_amt,
    	    	ifnull(sum(case when a.debit_credit = 'C' then a.accounting_amt else 0 end ), 0) as credit_amt 
    	FROM
    	    	fab_teller_seq b 
    	JOIN
    	    	fab_accounting_voch a 
    	    	    	ON a.trxn_date = b.trxn_date AND a.trxn_seq = b.trxn_seq 
    	    	    	AND a.corpno = b.corpno 
    	WHERE
    	    	b.corpno = #org_id# AND b.trxn_date = #trxn_date# 
    	    	AND b.sett_batch_no = #sett_batch_no# AND a.on_bal_sheet_ind = 'Y' 
    	    	and b.sett_status='2' 
    	GROUP BY
    	    	a.trxn_ccy, b.trxn_branch ,a.debit_credit 
    	ORDER BY
    	    	a.trxn_ccy,
    	    	a.debit_credit 
    	]]></sql>
        <sql type="db2"><![CDATA[
    	SELECT
    	    	a.trxn_ccy as ccy_code, b.trxn_branch, a.debit_credit, value(sum(case when a.debit_credit = 'D' then a.accounting_amt else 0 end ), 0) as debit_amt,
    	    	value(sum(case when a.debit_credit = 'C' then a.accounting_amt else 0 end ), 0) as credit_amt 
    	FROM
    	    	fab_teller_seq b 
    	JOIN
    	    	fab_accounting_voch a 
    	    	    	ON a.trxn_date = b.trxn_date AND a.trxn_seq = b.trxn_seq 
    	    	    	AND a.corpno = b.corpno 
    	WHERE
    	    	b.corpno = #org_id# AND b.trxn_date = #trxn_date# 
    	    	AND b.sett_batch_no = #sett_batch_no# AND a.on_bal_sheet_ind = 'Y' 
    	    	and b.sett_status='2' 
    	GROUP BY
    	    	a.trxn_ccy, b.trxn_branch ,a.debit_credit 
    	ORDER BY
    	    	a.trxn_ccy,
    	    	a.debit_credit 
    	]]></sql>
        <parameterMap class="java.util.Map">
            <parameter property="org_id" ref="GlDict.A.org_id" jdbcType="VARCHAR" javaType="BaseType.U_CORPNO" mode="in" longname="法人代码" parameterType="condition"/>
            <parameter property="trxn_date" ref="GlDict.A.trxn_date" jdbcType="VARCHAR" javaType="GlBaseType.U_DATE" mode="in" longname="交易日期" parameterType="condition"/>
            <parameter property="sett_batch_no" ref="GlDict.A.sett_batch_no" jdbcType="VARCHAR" javaType="BaseType.U_SEQUNO" mode="in" longname="清算批次号" parameterType="condition"/>
        </parameterMap>
        <resultMap class="ComFaAccounting.SettlePrepFlatData"/>
    </select>
    <select cache="none" method="selectAll" type="sql" id="lstSettDataNetting" longname="批量清算数据准备批量扎差补平">
        <sql type="oracle"><![CDATA[
    	SELECT
    	    	a.trxn_ccy as ccy_code, b.trxn_branch, nvl(sum(case when a.debit_credit = 'D' then a.accounting_amt else - a.accounting_amt end ), 0) as debit_amt 
    	FROM
    	    	fab_teller_seq b 
    	JOIN
    	    	fab_accounting_voch a 
    	    	    	ON a.trxn_date = b.trxn_date AND a.trxn_seq = b.trxn_seq 
    	    	    	AND a.corpno = b.corpno 
    	WHERE
    	    	b.corpno = #org_id# AND b.trxn_date = #trxn_date# 
    	    	AND b.sett_batch_no = #sett_batch_no# AND a.on_bal_sheet_ind = 'Y' 
    	    	and b.sett_status='2' 
    	GROUP BY
    	    	a.trxn_ccy, b.trxn_branch 
    	ORDER BY
    	    	a.trxn_ccy,
    	    	b.trxn_branch 
    	]]></sql>
        <sql type="mysql"><![CDATA[
    	SELECT
    	    	a.trxn_ccy as ccy_code, b.trxn_branch, ifnull(sum(case when a.debit_credit = 'D' then a.accounting_amt else - a.accounting_amt end ), 0) as accounting_amt 
    	FROM
    	    	fab_teller_seq b 
    	JOIN
    	    	fab_accounting_voch a 
    	    	    	ON a.trxn_date = b.trxn_date AND a.trxn_seq = b.trxn_seq 
    	    	    	AND a.corpno = b.corpno 
    	WHERE
    	    	b.corpno = #org_id# AND b.trxn_date = #trxn_date# 
    	    	AND b.sett_batch_no = #sett_batch_no# AND a.on_bal_sheet_ind = 'Y' 
    	    	and b.sett_status='2' 
    	GROUP BY
    	    	a.trxn_ccy, b.trxn_branch 
    	ORDER BY
    	    	a.trxn_ccy,
    	    	b.trxn_branch 
    	]]></sql>
        <sql type="db2"><![CDATA[
    	SELECT
    	    	a.trxn_ccy as ccy_code, b.trxn_branch, value(sum(case when a.debit_credit = 'D' then a.accounting_amt else - a.accounting_amt end ), 0) as debit_amt 
    	FROM
    	    	fab_teller_seq b 
    	JOIN
    	    	fab_accounting_voch a 
    	    	    	ON a.trxn_date = b.trxn_date AND a.trxn_seq = b.trxn_seq 
    	    	    	AND a.corpno = b.corpno 
    	WHERE
    	    	b.corpno = #org_id# AND b.trxn_date = #trxn_date# 
    	    	AND b.sett_batch_no = #sett_batch_no# AND a.on_bal_sheet_ind = 'Y' 
    	    	and b.sett_status='2' 
    	GROUP BY
    	    	a.trxn_ccy, b.trxn_branch 
    	ORDER BY
    	    	a.trxn_ccy,
    	    	b.trxn_branch 
    	]]></sql>
        <parameterMap class="java.util.Map">
            <parameter property="org_id" ref="GlDict.A.org_id" jdbcType="VARCHAR" javaType="BaseType.U_CORPNO" mode="in" longname="法人代码" parameterType="condition"/>
            <parameter property="trxn_date" ref="GlDict.A.trxn_date" jdbcType="VARCHAR" javaType="GlBaseType.U_DATE" mode="in" longname="交易日期" parameterType="condition"/>
            <parameter property="sett_batch_no" ref="GlDict.A.sett_batch_no" jdbcType="VARCHAR" javaType="BaseType.U_SEQUNO" mode="in" longname="清算批次号" parameterType="condition"/>
        </parameterMap>
        <resultMap class="ComFaAccounting.SettlePrepFlatData"/>
    </select>
</sqls>
